<!DOCTYPE html>
<html>

<head>
  <title>Species Choices Experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <!-- This is for data storage - please be sure to keep this script in all future updates to the code!! -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />

  <style>
    .jspsych-btn img {
      /* Adjust the width and height of the images in the buttons */
      width: 180px !important;
      height: 180px !important;
      object-fit: contain !important;
    }
  </style>

</head>

<body></body>
<script>

  // initialize jsPsych
  var jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData();
    }
  });

  // create timeline
  var timeline = [];

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //create a unique filename by combining a random string and a millisecond counter (to avoid duplicates)
  var random_id = jsPsych.randomization.randomID(10);
  const date = new Date();
  random_id = "p" + random_id.toString();
  var file_id = random_id + "_" + date.getTime().toString();
  const filename = `${file_id}.csv`;
  //also store the random id for convenience
  jsPsych.data.addProperties({
    random_id: random_id,
  });
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS

  // preload images
  var preload = {
    type: jsPsychPreload,
    images: [
      'stimuli/bike.png',
      'stimuli/boat.png',
      'stimuli/bunny.png',
      'stimuli/cant decide.png',
      'stimuli/cat.png',
      'stimuli/clam.png',
      'stimuli/dog.png',
      'stimuli/pens.png',
      'stimuli/person.png',
      'stimuli/pig.png',
      'stimuli/pigeon.png',
      'stimuli/plate.png'
    ]
  };
  timeline.push(preload);

  // define welcome message trial
  var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "Welcome to the experiment. Press any key to begin."
  };
  timeline.push(welcome);

  // define conditions: "You" vs. "King Triton"
  let conditions = [
    {
      name: "You",
      instructions: `<p>We are going to ask you some moral questions in which you have to make
                choices. These questions can be hard to decide. There is no right or wrong
                answer - you just choose whatever you personally think is right. Please
                choose whatever you would actually choose in real life.</p>
                <p>Press any key to begin.</p>`
    }
  ];

  test_condition = conditions[Math.floor(Math.random() * conditions.length)];

  // instructions for trials
  var instruction = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: test_condition.instructions
  };
  timeline.push(instruction)

  // define trials
  var test_stimuli = [
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['1 person', '1 dog']
    },
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['1 person', '10 dogs']
    },
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['1 person', '100 dogs']
    },
    {
      choices: ['<img src="stimuli/dog.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/person.png">'],
      prompt: ['1 dog', '10 people']
    },
    {
      choices: ['<img src="stimuli/dog.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/person.png">'],
      prompt: ['100 dog', '10 people']
    },
    {
      choices: ['<img src="stimuli/dog.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/person.png">'],
      prompt: ['1 dog', '100 people']
    },
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['100 people', '10 dog']
    },
    {
      choices: ['<img src="stimuli/plate.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['A plate', '1 dog']
    },
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/bike.png">'],
      prompt: ['1 person', 'A bike']
    },
    {
      choices: ['<img src="stimuli/plate.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/person.png">'],
      prompt: ['A plate', '1 person']
    }
  ];

  //randomize order of test stimuli
  test_stimuli = jsPsych.randomization.shuffle(test_stimuli);

  // Pre-test trial to introduce the boat scenario
  var pre_test = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `<p>Imagine a situation involving two boats. Both of these boats are sinking. 
                Unfortunately, no one on either of the boats is able to swim. But ${test_condition.name} can
                choose one boat to save. Once ${test_condition.name} choose a boat, everyone on that boat will
                be safe.</p>`,
    choices: ['<img src="stimuli/boat.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/boat.png">'],
    prompt: `<p>${test_condition.name} can either save the left boat or right boat. If it's too difficult to choose between
                them, ${test_condition.name} can select 'Can't decide'.</p>`
  }
  timeline.push(pre_test);

  // iterate through test stimuli and create a trial for each one
  for (let i = 0; i < test_stimuli.length; i++) {
    console.log("current trial: ", i);
    current_trial = test_stimuli[i];

    const A = current_trial.choices[0];
    const B = current_trial.choices[2];
    const cantDecide = "Can't decide"; 

    // randominzing withing subjects option order 
    const swap = Math.random() < 0.5;

    const leftChoice  = swap ? B : A;
    const rightChoice = swap ? A : B;

    var test = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `On one boat there is <b>${test_stimuli[i].prompt[0]}</b> and the other boat there is <b>${test_stimuli[i].prompt[1]}</b>.
                 Will <b>${test_condition.name}</b> save...`,
        choices: [leftChoice, '<img src="stimuli/cant decide.png">', rightChoice],
        prompt: `<p>${test_condition.name} can either choose the <b>left</b> boat or the <b>right</b> boat. If it's too difficult to choose between
                    them, ${test_condition.name} can select 'Can't decide'.</p>`,

      data: {
      const: t = jsPsych.getCurrentTrial(),
      trial_index: i,
      swap: swap,
      left_is: swap ? "B" : "A",
      right_is: swap ? "A" : "B",
      choice_options: test_stimuli[i].prompt,
      // Optional: store labels so you can decode responses later
      optionA_label: current_trial.prompt[0],
      optionB_label: current_trial.prompt[1],
    }
    }

    timeline.push(test);

  var iti = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '<div style="font-size:40px; opacity:0.6;">+</div>',
    choices: "NO_KEYS",
    trial_duration: 500,
    data: { task: "iti" }
  };    
  timeline.push(iti);
  }

  var hypothesis_check = {
    type: jsPsychSurveyText,
    questions: [
      {
        prompt: "What do you think this experiment was about?",
        rows: 4,
        columns: 50
      }
    ],
    data: { task: "hypothesis_check" }
  };

  timeline.push(hypothesis_check);

  var difficulty_check = {
    type: jsPsychSurveyLikert,
    questions: [
      {
        prompt: "How difficult were the decisions in this experiment?",
        labels: ["Very easy", "Easy", "Neutral", "Difficult", "Very difficult"],
        required: true
      }
    ],
    data: { task: "difficulty_rating" }
  };

  timeline.push(difficulty_check);

  var technical_check = {
    type: jsPsychSurveyText,
    questions: [
      {
        prompt: "Did you experience any technical problems during the experiment? (e.g., images not loading, buttons not working, lag)",
        rows: 3,
        columns: 50
      }
    ],
    data: { task: "technical_check" }
  };

  timeline.push(technical_check);

  var demographics = {
    type: jsPsychSurveyMultiChoice,
    questions: [
      {
        prompt: "What is your age range?",
        name: "age_bracket",
        options: ["Under 18", "18 to 24", "25 to 34", "35 to 44", "45 to 54", "55 to 64", "65+"],
        required: true
      },
      {
        prompt: "Gender (optional):",
        name: "gender",
        options: ["Woman", "Man", "Non-binary", "Prefer to self-describe", "Prefer not to say"],
        required: false
      },
      {
        prompt: "English proficiency:",
        name: "english_proficiency",
        options: ["Not fluent", "Somewhat fluent", "Fluent", "Native / near-native"],
        required: true
      },
      {
        prompt: "Do you currently have a pet?",
        name: "pet_ownership",
        options: ["Yes", "No"],
        required: true
      },
      {
        prompt: "Diet (optional):",
        name: "diet",
        options: ["Omnivore", "Vegetarian", "Vegan", "Other", "Prefer not to say"],
        required: false
      }
    ],
    preamble: "<p>Please answer a few quick questions.</p>",
    data: { task: "demographics" }
  };
  timeline.push(demographics);

  var debrief = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>Debrief</h2>
      <p>
        Thank you for participating in this study.
      </p>
      <p>
        This experiment examined how people make moral decisions when choosing 
        between humans and animals. We are interested in how different age groups 
        and conditions influence these decisions.
      </p>
      <p>
        You were not told the specific research question beforehand in order to 
        avoid influencing your responses.
      </p>
      <p>
        There were no right or wrong answers, we were interested in your 
        personal judgments.
      </p>`,
    choices: ["Finish"],
    data: { task: "debrief" }
  };

  timeline.push(debrief);


  // define test procedure with randomization
  var test_procedure = {
    timeline: [test],
    timeline_variables: test_stimuli,
    randomize_order: true, //randomize order of stimuli
  };

  //timeline.push(test_procedure);

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //this portion of the code ensures that the data gets sent to be stored on OSF
  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "YIIGIhMdy5S2",
    filename: filename,
    data_string: () => jsPsych.data.get().csv()
  };
  timeline.push(save_data);
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS

  // start the experiment
  jsPsych.run(timeline);

</script>

</html>