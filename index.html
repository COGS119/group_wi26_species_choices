<!DOCTYPE html>
<html>

<head>
  <title>Species Choices Experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <!-- This is for data storage - please be sure to keep this script in all future updates to the code!! -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />

  <style>
    .jspsych-btn img {
      /* Adjust the width and height of the images in the buttons */
      width: 180px !important;
      height: 180px !important;
      object-fit: contain !important;
    }
  </style>

</head>

<body></body>
<script>

  // initialize jsPsych
  var jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData();
    }
  });

  // create timeline
  var timeline = [];

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //create a unique filename by combining a random string and a millisecond counter (to avoid duplicates)
  var random_id = jsPsych.randomization.randomID(10);
  const date = new Date();
  random_id = "p" + random_id.toString();
  var file_id = random_id + "_" + date.getTime().toString();
  const filename = `${file_id}.csv`;
  //also store the random id for convenience
  jsPsych.data.addProperties({
    random_id: random_id,
  });
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS

  // preload images
  var preload = {
    type: jsPsychPreload,
    images: [
      'stimuli/bike.png',
      'stimuli/boat.png',
      'stimuli/bunny.png',
      'stimuli/cant decide.png',
      'stimuli/cat.png',
      'stimuli/clam.png',
      'stimuli/dog.png',
      'stimuli/pens.png',
      'stimuli/person.png',
      'stimuli/pig.png',
      'stimuli/pigeon.png',
      'stimuli/plate.png'
    ]
  };
  timeline.push(preload);

  // define welcome message trial
  var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "Welcome to the experiment. Press any key to begin."
  };
  timeline.push(welcome);

  // define conditions: "You" vs. "King Triton"
  let conditions = [
    {
      name: "You",
      instructions: `<p>We are going to ask you some moral questions in which you have to make
                choices. These questions can be hard to decide. There is no right or wrong
                answer - you just choose whatever you personally think is right. Please
                choose whatever you would actually choose in real life.</p>
                <p>Press any key to begin.</p>`
    },
    {
      name: "King Triton",
      instructions: `<p>We are going to ask you some moral questions. In these questions you are
                asked to guess how a person called<b> Mr X </b> who always does what is
                right would choose. In order words, you are asked to choose the option that
                you think is the morally right choice.</p>`
    }
  ];

  test_condition = conditions[Math.floor(Math.random() * conditions.length)];

  // instructions for trials
  var instruction = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: test_condition.instructions
  };
  timeline.push(instruction)

  //define control trials
  var control_stimuli = [
    {
      choices: ['<img src="stimuli/plate.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['A plate', '1 dog']
    },
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/bike.png">'],
      prompt: ['1 person', 'A bike']
    },
    {
      choices: ['<img src="stimuli/plate.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/person.png">'],
      prompt: ['A plate', '1 person']
    }
  ];

  // define trials
  var test_stimuli = [
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['1 person', '1 dog']
    },
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['1 person', '10 dogs']
    },
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['1 person', '100 dogs']
    },
    {
      choices: ['<img src="stimuli/dog.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/person.png">'],
      prompt: ['1 dog', '10 people']
    },
    {
      choices: ['<img src="stimuli/dog.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/person.png">'],
      prompt: ['100 dog', '10 people']
    },
    {
      choices: ['<img src="stimuli/dog.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/person.png">'],
      prompt: ['1 dog', '100 people']
    },
    {
      choices: ['<img src="stimuli/person.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/dog.png">'],
      prompt: ['100 people', '10 dog']
    },
  ];

  // Pre-test trial to introduce the boat scenario
  var pre_test = {
    type: jsPsychImageKeyboardResponse,
    type: jsPsychHtmlButtonResponse,
    stimulus: `<p>Imagine a situation involving two boats. Both of these boats are sinking. 
                Unfortunately, no one on either of the boats is able to swim. But <b>${test_condition.name}</b> can
                choose one boat to save. Once <b>${test_condition.name}</b> choose a boat, everyone on that boat will
                be safe.</p>`,
    choices: ['<img src="stimuli/boat.png">', '<img src="stimuli/cant decide.png">', '<img src="stimuli/boat.png">'],
    prompt: `<p><b>${test_condition.name}</b> can either save Boat A or Boat B. If it's too difficult to choose between
                them, <b>${test_condition.name}</b> can select 'Can't decide'.</p>`
  }
  timeline.push(pre_test);

  // go through the control stimuli
  for (let i = 0; i < control_stimuli.length; i++) {
    current_trial = control_stimuli[i];

    var control = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `On one boat there is ${control_stimuli[i].prompt[0]} and the other boat there is ${control_stimuli[i].prompt[1]}. Will <b>${test_condition.name}</b> save...`,
        choices: control_stimuli[i].choices,
        prompt: `<p><b>${test_condition.name}</b> can either choose Option A or Option B. If it's too difficult to choose between
                    them, <b>${test_condition.name}</b> can select 'Can't decide'.</p>`
    }
    timeline.push(control);
  }


  // iterate through test stimuli and create a trial for each one
  for (let i = 0; i < test_stimuli.length; i++) {
    console.log("current trial: ", i);
    current_trial = test_stimuli[i];

    const A = current_trial.choices[0];
    const B = current_trial.choices[2];
    const cantDecide = "Can't decide"; 

    // randominzing withing subjects option order 
    const swap = Math.random() < 0.5;

    const leftChoice  = swap ? B : A;
    const rightChoice = swap ? A : B;

    var test = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `On one boat there is <b>${test_stimuli[i].prompt[0]}</b> and the other boat there is <b>${test_stimuli[i].prompt[1]}</b>.
                 Will <b>${test_condition.name}</b> save...`,
        choices: [leftChoice, cantDecide, rightChoice],
        prompt: `<p><b>${test_condition.name}</b> can either choose Option A or Option B. If it's too difficult to choose between
                    them, <b>${test_condition.name}</b> can select 'Can't decide'.</p>`,

      data: {
      trial_index: i,
      swap: swap,
      left_is: swap ? "B" : "A",
      right_is: swap ? "A" : "B",
      // Optional: store labels so you can decode responses later
      optionA_label: current_trial.prompt[0],
      optionB_label: current_trial.prompt[1],
    }
    }

    timeline.push(test);
  }

  var hypothesis_check = {
    type: jsPsychSurveyText,
    questions: [
      {
        prompt: "What do you think this experiment was about?",
        rows: 4,
        columns: 50
      }
    ],
    data: { task: "hypothesis_check" }
  };

  timeline.push(hypothesis_check);

  var difficulty_check = {
    type: jsPsychSurveyLikert,
    questions: [
      {
        prompt: "How difficult were the decisions in this experiment?",
        labels: ["Very easy", "Easy", "Neutral", "Difficult", "Very difficult"],
        required: true
      }
    ],
    data: { task: "difficulty_rating" }
  };

  timeline.push(difficulty_check);

  var technical_check = {
    type: jsPsychSurveyText,
    questions: [
      {
        prompt: "Did you experience any technical problems during the experiment? (e.g., images not loading, buttons not working, lag)",
        rows: 3,
        columns: 50
      }
    ],
    data: { task: "technical_check" }
  };

  timeline.push(technical_check);

  // define test procedure with randomization
  var test_procedure = {
    timeline: [test],
    timeline_variables: test_stimuli,
    randomize_order: true, //randomize order of stimuli
  };

  //timeline.push(test_procedure);

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //this portion of the code ensures that the data gets sent to be stored on OSF
  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "YIIGIhMdy5S2",
    filename: filename,
    data_string: () => jsPsych.data.get().csv()
  };
  timeline.push(save_data);
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS

  // start the experiment
  jsPsych.run(timeline);

</script>

</html>